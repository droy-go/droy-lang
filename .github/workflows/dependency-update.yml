# =============================================================================
# Droy Language - Dependency Update Automation
# =============================================================================
# This workflow automatically checks for and updates dependencies,
# including GitHub Actions and LLVM versions.
# =============================================================================

name: Dependency Update

on:
  schedule:
    # Run at 00:00 UTC on the first day of each month
    - cron: '0 0 1 * *'
  workflow_dispatch:

jobs:
  # ==========================================================================
  # Update GitHub Actions
  # ==========================================================================
  update-actions:
    runs-on: ubuntu-latest
    name: Update GitHub Actions
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Check for action updates
      uses: renovatebot/github-action@v40.1.0
      with:
        configurationFile: .github/renovate.json
        token: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true

  # ==========================================================================
  # Check LLVM Versions
  # ==========================================================================
  check-llvm-versions:
    runs-on: ubuntu-latest
    name: Check LLVM Versions
    
    strategy:
      matrix:
        llvm_version: ['14', '15', '16', '17', '18']
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Test with LLVM ${{ matrix.llvm_version }}
      run: |
        sudo apt-get update
        sudo apt-get install -y llvm-${{ matrix.llvm_version }} llvm-${{ matrix.llvm_version }}-dev clang-${{ matrix.llvm_version }}
        
        export LLVM_CONFIG=llvm-config-${{ matrix.llvm_version }}
        export CC=clang-${{ matrix.llvm_version }}
        export CXX=clang++-${{ matrix.llvm_version }}
        
        cmake -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=ON
        cmake --build build -j$(nproc)
        cd build && ctest --output-on-failure
