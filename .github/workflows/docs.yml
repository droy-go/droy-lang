# =============================================================================
# Droy Language - Documentation Deployment
# =============================================================================
# This workflow builds and deploys the Droy language documentation to GitHub Pages.
# It automatically generates API documentation using Doxygen and deploys
# the project's documentation website.
#
# Trigger: Push to main branch affecting docs/
# =============================================================================

name: Documentation

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'include/**'
      - 'src/**'
      - 'README.md'
      - '.github/workflows/docs.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'docs/**'
      - '.github/workflows/docs.yml'
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # ==========================================================================
  # Build Documentation
  # ==========================================================================
  build:
    runs-on: ubuntu-latest
    name: Build Documentation
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          doxygen \
          graphviz \
          plantuml \
          python3 \
          python3-pip
    
    - name: Install Python dependencies
      run: |
        pip3 install \
          mkdocs \
          mkdocs-material \
          pymdown-extensions \
          mkdocstrings \
          mkdocstrings-cpp
    
    # ======================================================================
    # Generate Doxygen Documentation
    # ======================================================================
    - name: Generate Doxygen docs
      run: |
        if [ -f docs/Doxyfile ]; then
          echo "Generating Doxygen documentation..."
          doxygen docs/Doxyfile
        else
          echo "Creating default Doxyfile..."
          mkdir -p docs
          cat > docs/Doxyfile << 'EOF'
        # Doxyfile for Droy Language
        PROJECT_NAME = "Droy Helper Language"
        PROJECT_VERSION = 1.0.0
        OUTPUT_DIRECTORY = docs/html/doxygen
        INPUT = include src llvm_backend README.md
        RECURSIVE = YES
        GENERATE_HTML = YES
        GENERATE_LATEX = NO
        EXTRACT_ALL = YES
        EXTRACT_PRIVATE = NO
        EXTRACT_STATIC = YES
        CALL_GRAPH = YES
        CALLER_GRAPH = YES
        HAVE_DOT = YES
        DOT_IMAGE_FORMAT = svg
        INTERACTIVE_SVG = YES
        USE_MDFILE_AS_MAINPAGE = README.md
        EOF
          doxygen docs/Doxyfile
        fi
      continue-on-error: true
    
    # ======================================================================
    # Build MkDocs Site
    # ======================================================================
    - name: Build MkDocs site
      run: |
        if [ -f mkdocs.yml ]; then
          echo "Building MkDocs site..."
          mkdocs build
        else
          echo "Creating default MkDocs configuration..."
          cat > mkdocs.yml << 'EOF'
        site_name: Droy Language Documentation
        site_description: Documentation for the Droy Helper Language
        site_author: Droy Team
        site_url: https://droy-go.github.io/droy-lang/
        
        theme:
          name: material
          palette:
            - scheme: default
              primary: indigo
              accent: indigo
              toggle:
                icon: material/brightness-7
                name: Switch to dark mode
            - scheme: slate
              primary: indigo
              accent: indigo
              toggle:
                icon: material/brightness-4
                name: Switch to light mode
          features:
            - navigation.tabs
            - navigation.sections
            - navigation.expand
            - search.suggest
            - search.highlight
        
        plugins:
          - search
          - mkdocstrings:
              handlers:
                cpp:
                  paths: [include]
        
        markdown_extensions:
          - pymdownx.highlight:
              anchor_linenums: true
          - pymdownx.inlinehilite
          - pymdownx.snippets
          - pymdownx.superfences
          - admonition
          - pymdownx.details
          - pymdownx.tabbed:
              alternate_style: true
          - tables
          - attr_list
          - md_in_html
        
        nav:
          - Home: index.md
          - Getting Started:
            - Installation: getting-started/installation.md
            - Quick Start: getting-started/quickstart.md
          - Language Reference:
            - Syntax: language/syntax.md
            - Types: language/types.md
            - Functions: language/functions.md
          - API Reference: api/
          - Contributing: contributing.md
          - Changelog: changelog.md
        EOF
          
          # Create basic documentation structure
          mkdir -p docs/getting-started docs/language
          
          # Create index.md from README if it doesn't exist
          if [ ! -f docs/index.md ] && [ -f README.md ]; then
            cp README.md docs/index.md
          fi
          
          # Create placeholder files
          touch docs/getting-started/installation.md
          touch docs/getting-started/quickstart.md
          touch docs/language/syntax.md
          touch docs/language/types.md
          touch docs/language/functions.md
          touch docs/contributing.md
          touch docs/changelog.md
          
          mkdocs build
        fi
      continue-on-error: true
    
    # ======================================================================
    # Prepare Site Directory
    # ======================================================================
    - name: Prepare site directory
      run: |
        mkdir -p _site
        
        # Copy MkDocs output
        if [ -d site ]; then
          cp -r site/* _site/
        fi
        
        # Copy Doxygen output
        if [ -d docs/html/doxygen ]; then
          mkdir -p _site/api
          cp -r docs/html/doxygen/html/* _site/api/ 2>/dev/null || true
        fi
        
        # Copy any existing documentation
        if [ -d docs/html ]; then
          cp -r docs/html/* _site/ 2>/dev/null || true
        fi
        
        # Create a simple index if none exists
        if [ ! -f _site/index.html ]; then
          cat > _site/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <meta http-equiv="refresh" content="0; url=./html/index.html">
            <title>Droy Language Documentation</title>
        </head>
        <body>
            <p>Redirecting to <a href="./html/index.html">documentation</a>...</p>
        </body>
        </html>
        EOF
        fi
        
        # Create .nojekyll file for GitHub Pages
        touch _site/.nojekyll
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: _site

  # ==========================================================================
  # Deploy to GitHub Pages
  # ==========================================================================
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
